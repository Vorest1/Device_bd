{% extends "base.html" %}
{% block content %}
  <style>
    /* Аккуратная геро-секция и KPI */
    .hero {
      border-radius: 1rem;
      padding: 1.25rem 1.5rem;
      background: linear-gradient(135deg, rgba(25,135,84,.08), rgba(13,110,253,.06));
      border: 1px solid rgba(0,0,0,.075);
    }

    .kpi {
      border-radius: 1rem;
      padding: .9rem 1rem;
      border: 1px solid rgba(0,0,0,.08);
    }

    .kpi h3 {
      margin: 0;
      font-size: 1.5rem;
      line-height: 1.1;
    }

    .kpi small { opacity: .8; }

    @media (min-width: 992px) {
      .kpi h3 { font-size: 1.75rem; }
    }

    /* Карточка "Автор проекта": фиксируем удобную ширину содержимого */
    .hero .col-lg-4 .card-body {
      --author-width: 360px;
      display: grid;
      justify-content: start;
    }
    .hero .col-lg-4 .about-list {
      width: var(--author-width);
      max-width: 100%;
    }

    /* Компактные колонки (подписи/значения) */
    .about-list .d-flex {
      flex-wrap: wrap;
      gap: .25rem .5rem;
      margin: 0;
    }
    .about-list dt {
      width: 120px;               /* подпись: Студент/Группа/Контакты */
      min-width: 120px;
      margin: 0;
      color: #6c757d;
    }
    .about-list dd {
      width: calc(100% - 120px);  /* исправлено (было 80px) */
      margin: 0 0 .35rem 0;
    }
    @media (max-width: 575.98px) {
      .about-list dt,
      .about-list dd { width: 100%; } /* на очень узких — в столбик */
    }

    /* Перенос длинных адресов и ников */
    .about-list dt,
    .about-list dd {
      overflow-wrap: anywhere;
      word-break: break-word;
    }
  </style>

  <!-- Сведения о БД (верх страницы) -->
  <div class="hero mb-4">
    <div class="row g-4 align-items-center">
      <div class="col-lg-8">
        <h2 class="mb-2">Главная · Сведения о базе данных</h2>
        <p class="mb-2">
          База данных «Цифровые устройства» — проект для удобного хранения и
          поиска информации об электронных устройствах (смартфоны, ноутбуки и др.),
          их производителях, характеристиках (дисплей, камера, батарея, спецификации)
          и предложениях продавцов. Система поддерживает быстрый поиск по атрибутам,
          фильтрацию по ценам и просмотр связанной справочной информации.
        </p>
      </div>
      <div class="col-lg-4">
        <div class="card shadow-sm">
          <div class="card-body">
            <h6 class="mb-3">Автор проекта</h6>
            <dl class="about-list d-flex flex-column mb-0">
              <div class="d-flex">
                <dt class="text-muted">Студент</dt>
                <dd><strong>Христофоров Владимир</strong></dd>
              </div>
              <div class="d-flex">
                <dt class="text-muted">Группа</dt>
                <dd><strong>ИВТ-Б22</strong></dd>
              </div>
              <div class="d-flex">
                <dt class="text-muted">Контакты</dt>
                <dd>
                  Email: {{ author_email or 'не указан' }}<br>
                  Telegram: {{ author_telegram or 'не указан' }}
                </dd>
              </div>
            </dl>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Сводные KPI -->
  <div class="row g-3">
    <div class="col-6 col-md-4 col-lg-3">
      <div class="kpi h-100">
        <small class="d-block text-muted">Устройства, всего</small>
        <h3>{{ totals['devices'] }}</h3>
      </div>
    </div>
    <div class="col-6 col-md-4 col-lg-3">
      <div class="kpi h-100">
        <small class="d-block text-muted">Категории</small>
        <h3>{{ totals['categories'] }}</h3>
      </div>
    </div>
    <div class="col-6 col-md-4 col-lg-3">
      <div class="kpi h-100">
        <small class="d-block text-muted">Производители</small>
        <h3>{{ totals['manufacturers'] }}</h3>
      </div>
    </div>
    <div class="col-6 col-md-4 col-lg-3">
      <div class="kpi h-100">
        <small class="d-block text-muted">Продавцы</small>
        <h3>{{ totals['retailers'] }}</h3>
      </div>
    </div>
    <div class="col-6 col-md-4 col-lg-3">
      <div class="kpi h-100">
        <small class="d-block text-muted">Устройств в наличии*</small>
        <h3>{{ in_stock_devices }}</h3>
      </div>
    </div>
    <div class="col-6 col-md-4 col-lg-3">
      <div class="kpi h-100">
        <small class="d-block text-muted">Предложений продавцов</small>
        <h3>{{ offers_total }}</h3>
      </div>
    </div>
  </div>
  
  <!-- Справка по БД (перенесено со старой search.html) -->
  <div class="card shadow-sm mt-4">
    <div class="card-body">
      <div class="d-flex flex-wrap align-items-end justify-content-between gap-2">
        <h5 class="mb-0">Справка по БД</h5>
        <form method="POST" class="row g-2">
          <input type="hidden" name="mode" value="info">
          <div class="col-auto">
            <label class="form-label mb-0 small text-muted">Группировать по</label>
            <select class="form-select form-select-sm" name="info_by">
              <option value="retailer"   {% if info_by == 'retailer' %}selected{% endif %}>Продавцу</option>
              <option value="country"    {% if info_by == 'country' %}selected{% endif %}>Стране</option>
            </select>
          </div>
          <div class="col-auto d-flex align-items-end">
            <button type="submit" class="btn btn-info btn-sm">Получить справку</button>
          </div>
        </form>
      </div>

      {% if mode == 'info' and info_results %}
        <div class="table-responsive mt-3">
          <table class="table table-bordered table-sm w-auto align-middle">
            <thead>
              <tr>
                <th class="text-nowrap">{% if info_by == 'retailer' %}Продавец{% else %}Страна{% endif %}</th>
                <th class="text-nowrap">Количество устройств</th>
              </tr>
            </thead>
            <tbody>
              {% for row in info_results %}
                <tr>
                  <td>{{ row[0] }}</td>
                  <td class="text-center">{{ row[1] }}</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      {% elif mode == 'info' %}
        <div class="alert alert-info mt-3">Здесь будет отображаться справка после выбора и нажатия «Получить справку».</div>
      {% else %}
        <div class="form-text mt-2">Выберите группировку и нажмите «Получить справку», чтобы увидеть агрегированную таблицу.</div>
      {% endif %}
    </div>
  </div>

  <div class="form-text mt-2">* Устройства, имеющиеся в наличии хотя бы у одного продавца</div>
{% endblock %}
