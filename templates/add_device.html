{% extends "base.html" %}
{% block content %}
  <h2>Добавление устройства</h2>
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      {% for cat, msg in messages %}
        <div class="alert alert-{{ cat }}">{{ msg }}</div>
      {% endfor %}
    {% endif %}
  {% endwith %}

  <form method="POST" class="row g-3">
    <!-- Производитель -->
    <div class="col-md-4">
      <label class="form-label">Производитель</label>
      <div class="input-group">
        <select class="form-select" name="manufacturer_id" required>
          <option value="" disabled selected>Выберите...</option>
          {% for m in manufacturers %}
            <option value="{{ m[0] }}">{{ m[1] }}</option>
          {% endfor %}
        </select>
        <a href="{{ url_for('add_manufacturer', next=request.path) }}" class="btn btn-outline-secondary" title="Добавить нового производителя">+</a>
      </div>
    </div>
    <!-- Категория -->
    <div class="col-md-4">
      <label class="form-label">Категория</label>
      <div class="input-group">
        <select class="form-select" name="category_id" required>
          <option value="" disabled selected>Выберите...</option>
          {% for c in categories %}
            <option value="{{ c[0] }}">{{ c[1] }}</option>
          {% endfor %}
        </select>
        <a href="{{ url_for('add_category', next=request.path) }}" class="btn btn-outline-secondary" title="Добавить новую категорию">+</a>
      </div>
    </div>
    <!-- Операционная система -->
    <div class="col-md-4">
      <label class="form-label">Операционная система</label>
      <div class="input-group">
        <select class="form-select" name="os_id" required>
          <option value="" disabled selected>Выберите...</option>
          {% for os in operating_systems %}
            <option value="{{ os[0] }}">{{ os[1] }} ({{ os[2] }})</option>
          {% endfor %}
        </select>
        <a href="{{ url_for('add_os', next=request.path) }}" class="btn btn-outline-secondary" title="Добавить ОС">+</a>
      </div>
    </div>
    <!-- Модель -->
    <div class="col-md-4">
      <label class="form-label">Модель</label>
      <div class="input-group">
        <!-- инпут с подсказками из datalist -->
        <input
          type="text"
          class="form-control"
          name="model"
          list="modelsList"
          maxlength="30"
          required
          placeholder="Начните вводить или выберите из списка..."
        >
        <datalist id="modelsList">
          {% for name in models %}
            <option value="{{ name }}"></option>
          {% endfor %}
        </datalist>

        <!-- Кнопка «+» как у категории -->
        <button type="button"
                class="btn btn-outline-secondary"
                id="addModelBtn"
                title="Добавить новую модель">
          +
        </button>
      </div>
      <div class="form-text">
        Выберите из списка существующих моделей или добавьте новую через «+».
      </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
      const addBtn = document.getElementById('addModelBtn');
      if (!addBtn) return;

      addBtn.addEventListener('click', () => {
        const input = document.querySelector('input[name="model"]');
        const current = (input?.value || '').trim();
        const name = prompt('Введите название модели', current);
        if (!name) return;

        // подставим введённое значение в поле
        input.value = name;

        // и добавим его в список подсказок, если там ещё нет
        const dl = document.getElementById('modelsList');
        if (dl && !Array.from(dl.options).some(o => o.value === name)) {
          const opt = document.createElement('option');
          opt.value = name;
          dl.appendChild(opt);
        }
      });
    });
    </script>
    <!-- Дата выпуска -->
    <div class="col-md-4">
      <label class="form-label">Дата выпуска</label>
      <input type="date" class="form-control" name="release_date"
             min="1990-01-01"  max="{{ today }}" required>
    </div>
    <!-- Текущая стоимость -->
    <div class="col-md-4">
      <label class="form-label">Текущая стоимость (₽)</label>
      <input type="number" class="form-control" name="current_price"
             step="0.01" min="0" max="1000000" required>
    </div>
    <!-- Вес -->
    <div class="col-md-4">
      <label class="form-label">Вес (грамм)</label>
      <input type="number" class="form-control" name="weight_grams"
             min="1" max="1000000" required>
    </div>
    <!-- Цвет -->
    <div class="col-md-4">
    <label class="form-label">Цвет</label>
    <div class="input-group">
      <select class="form-select" name="color_id" required>
        <option value="" disabled selected>Выберите...</option>
        {% for c in colors %}
          <option value="{{ c[0] }}">{{ c[1] }}</option>
        {% endfor %}
      </select>
      <!-- НОВОЕ: плюс для добавления цвета -->
      <a href="{{ url_for('add_row', table_name='color', next=request.path) }}"
        class="btn btn-outline-secondary"
        title="Добавить цвет">+</a>
    </div>
  </div>
    <!-- Гарантия -->
    <div class="col-md-4">
      <label class="form-label">Гарантия (мес)</label>
      <input type="number" class="form-control" name="warranty_months"
             min="1" max="24" required>
    </div>
    <!-- Водонепроницаемость -->
    <div class="col-md-4">
      <label class="form-label">Водонепроницаемость</label>
      <div class="form-check mt-2">
        <input class="form-check-input" type="checkbox" name="is_waterproof" id="waterproof">
        <label class="form-check-label" for="waterproof">Есть</label>
      </div>
    </div>

    <hr>
    <!-- Перенесено: формы продавцов теперь на вкладке «Продавцы» (edit_extras) -->
    <div class="col-12 d-flex justify-content-end">
      <button type="submit" class="btn btn-success mt-3">Добавить устройство</button>
    </div>
  </form>

  <script>
document.addEventListener('DOMContentLoaded', () => {
  const FORM = document.querySelector('form');
  if (!FORM) return;

  const KEY = 'addDeviceForm:v3';

  // ---------- restore ----------
  (function restore() {
    const raw = localStorage.getItem(KEY);
    if (!raw) return;
    let data;
    try { data = JSON.parse(raw); } catch { localStorage.removeItem(KEY); return; }

    // 1) Обычные поля (все [name], кроме массивов name="...[]")
    FORM.querySelectorAll('[name]:not([name$="[]"])').forEach(el => {
      if (!(el.name in data.scalars)) return;
      if (el.type === 'checkbox' || el.type === 'radio') {
        el.checked = !!data.scalars[el.name];
      } else {
        // для <select> — ставим только если значение есть среди опций
        if (el.tagName === 'SELECT') {
          const val = String(data.scalars[el.name]);
          if (Array.from(el.options).some(o => o.value === val)) el.value = val;
        } else {
          el.value = data.scalars[el.name];
        }
      }
    });

    // 2) Динамические массивы продавцов (если такие элементы есть на странице)
    const arrays = data.arrays || {};
    const blocks = () => document.querySelectorAll('.retailer-block');
    const addBtn = document.getElementById('add-retailer-btn');

    if (arrays['retailer_id[]'] || arrays['site_price[]'] || arrays['last_updated[]']) {
      const need = Math.max(
        arrays['retailer_id[]']?.length || 0,
        arrays['site_price[]']?.length  || 0,
        arrays['last_updated[]']?.length|| 0
      );
      if (need > blocks().length && addBtn) {
        for (let i = blocks().length; i < need; i++) addBtn.click();
      }
      const blks = blocks();
      for (let i = 0; i < need && i < blks.length; i++) {
        const b = blks[i];
        const set = (sel, val) => { const el = b.querySelector(sel); if (!el) return;
          if (el.tagName === 'SELECT') {
            if (Array.from(el.options).some(o => o.value == val)) el.value = val;
          } else { el.value = val; }
        };
        if (arrays['retailer_id[]']) set('[name="retailer_id[]"]', arrays['retailer_id[]'][i] ?? '');
        if (arrays['site_price[]'])  set('[name="site_price[]"]',  arrays['site_price[]'][i]  ?? '');
        if (arrays['last_updated[]'])set('[name="last_updated[]"]',arrays['last_updated[]'][i]?? '');
        // чекбокс наличия
        const ch = b.querySelector('[type="checkbox"]');
        if (ch && Object.prototype.hasOwnProperty.call(data.checks, 'in_stock'+i)) {
          ch.checked = !!data.checks['in_stock'+i];
        }
      }
    }

    // одноразовое восстановление
    localStorage.removeItem(KEY);
  })();

  // ---------- save before leaving to any dict "plus" link ----------
  function isDictAddLink(a) {
    if (!a || a.tagName !== 'A') return false;
    if (a.classList.contains('dict-add-btn')) return true; // если добавите класс — будет надёжнее
    const href = a.getAttribute('href') || '';
    // покрываем add_manufacturer, add_category, add_os, add_retailer, add_row?table_name=...
    return /\/add_/.test(href) || href.includes('add_row') || href.includes('table_name=');
  }

  function collectData() {
    const scalars = {};
    const arrays  = {};
    const checks  = {};

    // обычные поля
    FORM.querySelectorAll('[name]:not([name$="[]"])').forEach(el => {
      if (el.type === 'checkbox' || el.type === 'radio') {
        scalars[el.name] = !!el.checked;
      } else {
        scalars[el.name] = el.value;
      }
    });

    // массивы (например retailer_id[], site_price[], last_updated[])
    const arrayNames = new Set(Array.from(FORM.querySelectorAll('[name$="[]"]')).map(el => el.name));
    arrayNames.forEach(n => {
      arrays[n] = Array.from(FORM.querySelectorAll(`[name="${n}"]`)).map(el => el.value);
    });

    // чекбоксы "в наличии" в блоках продавцов (in_stock0, in_stock1, ...)
    document.querySelectorAll('.retailer-block').forEach((b, idx) => {
      const ch = b.querySelector('[type="checkbox"]');
      if (ch) checks['in_stock' + idx] = !!ch.checked;
    });

    return { scalars, arrays, checks, ts: Date.now() };
  }

  // Сохраняем при клике на любую «плюсовую» ссылку (делегирование события – работает и для новых ссылок)
  ['pointerdown', 'click'].forEach(evt =>
    document.addEventListener(evt, (e) => {
      const a = e.target.closest('a');
      if (!isDictAddLink(a)) return;
      try { localStorage.setItem(KEY, JSON.stringify(collectData())); } catch {}
    }, true) // capture, чтобы сработало до навигации
  );
});
</script>



{% endblock %}
