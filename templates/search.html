{% extends "base.html" %}
{% block content %}
<h2>Поиск</h2>

<ul class="nav nav-tabs mb-3" role="tablist">
  <li class="nav-item" role="presentation">
    <button class="nav-link {% if mode == 'by1' %}active{% endif %}" data-bs-toggle="tab" data-bs-target="#by1" type="button" role="tab">
      1 атрибут: Производитель
    </button>
  </li>
  <li class="nav-item" role="presentation">
    <button class="nav-link {% if mode == 'by2' %}active{% endif %}" data-bs-toggle="tab" data-bs-target="#by2" type="button" role="tab">
      2 атрибута: Страна + Цвет
    </button>
  </li>
</ul>

<div class="tab-content">
  <!-- Вкладка 1: Производитель (ручной submit) -->
  <div class="tab-pane fade {% if mode == 'by1' %}show active{% endif %}" id="by1" role="tabpanel">
    <form method="POST" class="row g-3 mb-3">
      <input type="hidden" name="mode" value="by1">
      <div class="col-md-6">
        <label class="form-label">Производитель</label>
        <select class="form-select" name="manufacturer_id" required>
          <option value="" disabled {% if not selected_manufacturer %}selected{% endif %}>Выберите...</option>
          {% for m in manufacturers %}
            <option value="{{ m[0] }}" {% if selected_manufacturer == m[0]|string %}selected{% endif %}>{{ m[1] }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-md-6 d-flex align-items-end">
        <button type="submit" class="btn btn-success">Найти</button>
      </div>
    </form>

    {% if results and mode == 'by1' %}
      {% include 'search_results_table.html' %}
    {% elif mode == 'by1' and selected_manufacturer %}
      <div class="alert alert-warning">Совпадений не найдено.</div>
    {% endif %}
  </div>

  <!-- Вкладка 2: Страна + Цвет (автоматический submit при выборе цвета) -->
  <div class="tab-pane fade {% if mode == 'by2' %}show active{% endif %}" id="by2" role="tabpanel">
    <form method="POST" class="row g-3 mb-3" id="by2-form">
      <input type="hidden" name="mode" value="by2">

      <div class="col-md-5">
        <label class="form-label">Страна</label>
        <select class="form-select" name="country_id" id="country_id" required>
          <option value="" disabled {% if not selected_country %}selected{% endif %}>Выберите...</option>
          {% for co in countries %}
            <option value="{{ co[0] }}" {% if selected_country == co[0]|string %}selected{% endif %}>{{ co[1] }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="col-md-5">
        <label class="form-label">Цвет</label>
        <select class="form-select" name="color_id" id="color_id" required disabled>
          <option value="" disabled selected>Сначала выберите страну</option>
        </select>
      </div>
<!-- 
      <div class="col-md-2 d-flex align-items-end">
        // Кнопка оставлена на случай, если потребуется вручную — но она не обязательна
        <button type="submit" class="btn btn-success w-100" id="by2-submit" disabled>Найти</button>
      </div> -->
    </form>

    {% if results and mode == 'by2' %}
      {% include 'search_results_table.html' %}
    {% elif mode == 'by2' and selected_country and selected_color %}
      <div class="alert alert-warning">Совпадений не найдено.</div>
    {% endif %}
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const countrySel = document.getElementById('country_id');
  const colorSel   = document.getElementById('color_id');
  const submitBtn  = document.getElementById('by2-submit');
  const by2Form    = document.getElementById('by2-form');

  async function loadColors(countryId, preset) {
    colorSel.innerHTML = '';
    colorSel.disabled = true;
    submitBtn && (submitBtn.disabled = true);

    if (!countryId) {
      colorSel.innerHTML = '<option value="" disabled selected>Сначала выберите страну</option>';
      return;
    }

    try {
      const url = `/api/attribute_values?attr=color&other_attr=country&other_val=${encodeURIComponent(countryId)}`;
      const resp = await fetch(url);
      const data = await resp.json(); // [{id,name}, ...]

      if (!data.length) {
        colorSel.innerHTML = '<option value="" disabled selected>Нет доступных цветов</option>';
        return;
      }

      // placeholder
      const ph = document.createElement('option');
      ph.value = '';
      ph.textContent = 'Выберите...';
      ph.disabled = true;
      ph.selected = !preset;
      colorSel.appendChild(ph);

      data.forEach(item => {
        const o = document.createElement('option');
        o.value = String(item.id);
        o.textContent = item.name;
        if (preset && String(preset) === String(item.id)) o.selected = true;
        colorSel.appendChild(o);
      });

      colorSel.disabled = false;
      submitBtn && (submitBtn.disabled = !colorSel.value);
    } catch (e) {
      colorSel.innerHTML = '<option value="" disabled selected>Ошибка загрузки</option>';
    }
  }

  // Подгрузка цветов при выборе страны
  if (countrySel) {
    countrySel.addEventListener('change', () => loadColors(countrySel.value, null));
  }

  // АВТОСАБМИТ: как только пользователь выбрал цвет — сразу запрос к серверу
  if (colorSel && by2Form) {
    colorSel.addEventListener('change', () => {
      const hasValue = !!colorSel.value;
      submitBtn && (submitBtn.disabled = !hasValue);
      if (hasValue) {
        // Корректная отправка формы (подхватывает валидацию HTML)
        if (by2Form.requestSubmit) by2Form.requestSubmit();
        else by2Form.submit();
      }
    });
  }

  // Восстановление состояния после POST: если выбрана страна — подгрузить цвета
  {% if mode == 'by2' and selected_country %}
    loadColors('{{ selected_country }}', '{{ selected_color or "" }}');
  {% endif %}
});
</script>

{% endblock %}
